[[ch02_bitcoin_overview]]
== כיצד ביטקוין פועל

=== עסקאות, בלוקים, כרייה, ושרשרת הבלוקים

((("bitcoin", "overview of", id="BCover02")))((("central trusted authority")))((("decentralized systems", "bitcoin overview", id="DCSover02"))) מערכת ביטקוין, שלא כמו מערכות תשלומים ובנקאות מסורתית. מבוססת על מערכת אמון מבוזר. במקום מערכת אמון ריכוזית, בביטקוין, אמון מושג כתכונה נגזרת מהאינטרקציה בין משתתפים שונים במערכת ביטקוין.   בפרק זה, נבחן את ביטקוין ברמת על בעזרת מעקב אחר עסקה בודדת ודרכה במערכת ביטקוין ונצפה בה תוך כדי שהיא הופכת ל"אמינה" ומתקבלת ע"י מנגנון ביטקוי ן של קונצנזוס מבוזר ואשר בסופו של דבר מתועדת בשרשרת הבלוקים, המהווה את ספר הנה"ח של כלל העסקות. פרקים עוקבים יצללו  לתוך הטכנולוגיה שמאחורי העסקות, הרשת, והכרייה. .

==== ביטקוין במבט על

בתרשים הכללי המוצג ב <<bitcoin-overview>>, אנו רואים שמערכת ביטקוין מורכבת ממשתמשים עם ארנקים המכילים מפתחות, עסקות אשר הופצו ברשת, וכורים אשר מייצרים (בדרך של תחרות חישובית) את קונצנזוס שרשרת הבלוקים, אשר הנה ספר הנ,ה"ח הסמכותי של כלל העסקות.


((("blockchain explorer sites"))) כל דוגמה המוצגת בפרק זה מבוססת על עסקה אמיתית שהתבצעה ברשת ביטקוין, המדמה את האינטרקציה בין משתמשים. (ג'ו, אליס, בוב וגופש) בדרך של משלוח כסף בין הארנקים. בעוד אנו עוקבים אחר העסקה דרך רשת ביטקוין אל שרשרת הבלוקים, נשתמש באתר _blockchain explorer_ להפוך כל צעד לחזותי. דפדפן בלוקצ'יין הנו אפליקצית ווב אשר פועלת כמנוע החיפוש של ביטקוין, בכך שהיא מאפשרת לך לבצע חיפוש של עסקות, כתובות, ובלוקים ולגלות את הקשרים והזרימה ביניהם. 

[[bitcoin-overview]]
ביטקוין במבט כללי
image::images/mbc2_0201.png["Bitcoin Overview"]

((("Bitcoin Block Explorer")))((("BlockCypher Explorer")))((("blockchain.info")))((("BitPay Insight"))) דפדפני בלוקצ'יין פופולריים כוללים את:

* https://live.blockcypher.com[BlockCypher Explorer]
* https://blockchain.info[blockchain.info]
* https://insight.bitpay.com[BitPay Insight]
* https://blockstream.info[Blockstream Explorer]

לכל אחד מאלה יש פונקצית חיפוש אשר יכולה לקחת כתובת ביטקוין, האש של עסקה, מספר בלוק, או האש של בלוק ולהביא את המידע הקשור מרשת ביטקוין. בכל דוגמת עסקה או בלוק, אנו נספק את כתובת הדף כדי שתוכל/י לבחון זאת בעצמך וללמוד את הפרטים.  


[[cup_of_coffee]]
==== קניית כוס קפה

((("use cases", "buying coffee", id="UCcoffee02"))) אליס.שהוצגה בפרק הקודם, הנה משתמשת חדשה אשר זה עתה רכשה ביטקוין. ב <<getting_first_bitcoin>>,  אליס נפגשה עם חברה, ג'ו, להחליף קצת קאש בביטקוין.  העסקה שג'ו יצר העבירה לארנקה של אליס סך של  0.10 BTC. כעת אליס תבצע את הרכישה הצרכנית שלה, קניית ספל קפה בבית הקפה של בוב בפאלו אלטו.

((("exchange rates", "determining"))) הקפה של בוב החל לאחרונה לקבל תשלומי ביטקוין. בעזרת הוספת אפשרות ביטקוין במערכת עמדת המכירה שלו. המחירים של בוב מוצגים במטבע מקומי (דולר אמריקאי), אך בדלפק, לקוחות יכולים לשלם בדולרים או בביטקוין. . אליס מזמינה את הקפה ובוב רושם את ההזמנה במערכת, כפי שהוא מבצע לכל עסקה שהיא.  נקודת המכירה מתרגמת מיידית את הערך מדולר לביטקוין בשער הנתון, ומציג את המחיר לפי שני המטבעות.  

----
סה"כ:
$1.50 USD
0.015 BTC
----


((("millibits")))Bob says, "That's one-dollar-fifty, or fifteen millibits."

((("payment requests")))((("QR codes", "payment requests"))) מערכת נקודת המכירה של בוב גם תיצור אוטומטית קוד QR מיוחד שכולל בקשת תשלום   _payment request_  (ראה<<payment-request-QR>>).

שלא כמו קוד QR אשר פשוט כולל את כתובת היעד של ביטקוין, בקשת תשלום הנה כתובת אינטרנט מוצפנת QR אשר כוללת כתובת יעד, סכום לתשלום, ותאור כללי כמו "קפה בוב". הדבר מאפשר לאפליקצית ארנק ביטקוין להזין מראש את המידע המשומש לשליחת התשלום כאשר מציג תאור בר קריאה אנושית למשתמש. ניתן לסרוק את קוד ה QR עם אפליקצית ארנק ביטקוין כדי לראות מה אליס תראה. 


[[payment-request-QR]]
קוד QR של בקשת תשלום
image::images/mbc2_0202.png["payment-request"]

[TIP]
====
((("QR codes", "warnings and cautions")))((("transactions", "warnings and cautions")))((("warnings and cautions", "avoid sending money to addresses appearing in book")))נסה/י לסרוק זאת בעזרת הארנק שלך לראות את כתובת וסכום העסקה אך אין לשלוח כסף.
====
[[payment-request-URL]]
.קוד הQR של בקשת התשלום מצפין את כתובת האינטרנט הבאה, המוגדרת ב BIP-21:
----
ביטקוין:1GdK9UzpHBzqzX2A9JFP3Di4weBwqgmoQA?
amount=0.015&
label=Bob%27s%20Cafe&
message=Purchase%20at%20Bob%27s%20Cafe

מרכיבי כתובת האינטרנו

כתובת ביטקוין: "1GdK9UzpHBzqzX2A9JFP3Di4weBwqgmoQA"
סכום לתשלום "0.015"
תוית עבור מקבל התשלום: "קפה בוב"
תאור התשלום: "רכישה אצל קפה בוב"
----

אליס משתמשת בסמארטפון שלה לסרוק את הברקוד שמוצג. הסמארטפון שלה מראה תשלום של +0.0150 BTC+ ל +Bob's Cafe+, והיא בוחרת "שלח" כדר לאשר את התשלום. תוך כמה שניות (בערך אותו הזמן של אישור כרטיס אשראי) בוב רואה שהעסקה נמצאת ברשומות, כך שהעסקה הושלמה. 

בקטעים הבאים, נבחן עסקה זו ביתר פירוט. נראה כיצד ארנקה של אליס בונה אותה, כיצד היא מופצת ברחבי הרשת, כיצד היא מאומתת, ולבסוף, כיצד בוב משלם בה בעסקות עוקבות.

[הערה]
====
((("fractional values")))((("milli-bitcoin")))((("satoshis")))רשת ביטקוין יכולה לבצע עסקות בערכים חלקיים, למשל ממיליביטקוין (1.1000 של ביטקוין) עד ל 1/100,000,000, של ביטקוין הידוע כסאטושי.   לאוך כל הספר נשתמש במושג ביטקוין או ביטקוינים בעת שמתיחסים לכמות הכסף בביטקוין  מהקטנה (סאטושי) עד לסך הכולל (21,000,000) של כל הביטקוינים שיכרו אי פעם.
====

תוכלו לבחון את העסקה של אליס עם קפה בוב בבלוקצ'יין עם שימוש באתר דפדפן הבלוקים (<<view_alice_transaction>>):

[[view_alice_transaction]]
.ראו את עסקת אייס באתר https://blockchain.info/tx/0627052b6f28912f2703066a912ea577f2ce4da4caa5a5fbd8a57286c345c2f2[blockchain.info]
====
----
https://blockchain.info/tx/0627052b6f28912f2703066a912ea577f2ce4da4caa5a5fbd8a57286c345c2f2
----
====

=== עסקות מערכת ביטקוין

((("transactions", "defined")))בשפה פשוטה עסקה משדרת לרשת שהבעלים של ערך כלשהו של ביטקוין אישר את ההעברה של הערך לבעלים אחר. . הבעלים החדש יכול כעת להוציא את הביטקוין ע"י יצירת עסקה אחרת אשר מאשרת העברה לבעלים אחר, וכך הלאה, בשרשרת של בעלויות. 

==== קלטים ופלטים של עסקה

((("transactions", "overview of", id="Tover02")))((("outputs and inputs", "basics of"))) עסקות הן כמו שורות בספר הנה"ח של פנקסאות כפולה. כל עסקה כוללת קלט אחד או יותר שהם כמו ההתחייבות כנגד חשבון ביטקוין. בצד האחר של העסקה יש פלט אחד או יותר, שהם כמו הזיכוייים שנוספו לחשבון ביטקוין.  ((("fees", "transaction fees"))) הקלטים והפלטים לא בהכרח מתכנסים לסכום דומה, במקום זאת, פלטים מסתכמים בקצת פחות מהקלטים והיתרה מייצגת במשתמע  _transaction fee_, אשר הנו סכום קטן שנגבה ע"י הכורה של העסקה בספר הנה"ח.. עסקת ביטקוין המוצגת ככניסה בספר ב <<transaction-double-entry>>.

העסקה גם כוללת הוכחת בעלות לכל סכום של ביטקוינים (קלטים) אשר ערכם מוצא, בצורה של חתימה דיגיטלית של הבעלים אשר יכול באופן עצמאי להיות מאומת ע"י כל אחד. ((("spending bitcoin", "defined")))I במונחי ביטקוין, הוצאה הנה חתימת העסקה אשר מעבירה ערך מבעלים של עסקה קודמת אל הבעלים החדש המזוהה ככתובת ביטקוין.

[[transaction-double-entry]]
עסקות הן ספר הנה"ח דו צדדי.
image::images/mbc2_0203.png["Transaction Double-Entry"]

==== שרשראות עסקות

((("chain of transactions"))) התשלום של אליס לקפה בוב משתמש בפלט של עסקה קודמת כקלט. . בפרק הקודם אליס קיבלה ביטקוין מחברה ג'ו בתמורה למזומן.  פעןלה זו יצרה עסקה שערכה נעול ע"י סיסמתה של אליס. העסקה החדשה שלה לקפה בוב מפנה לעסקה הקודמת כטקלט, ויוצרת פלטים חדשים לשלם לקפה בוב ולהחזיר לעצמה עודף.   העסקות יוצרות שרשרת בה הקלט של העסקה הנוכחית מקושר לפלט של עסקה קודמת. המפתח של אליס הנו  החותמת שמשחררת את הפלטים של העסקה הקודמת ובכך מוכיחה לרשת ביטקוין שהיא הבעלים של הכסף. ,  היא מצמידה את התשלום לבוב לכתובת שלו ובכך מעמיסה על הפלט את הדרישה שבוב צריך לספק חתימה כדי להוציא את הסכום.,  זוהי העברת הערך בין אליס לבוב. שרשרת עסקות זו מג'ו לאליס לבוב מוצגת ב <<blockchain-mnemonic>>.

[[blockchain-mnemonic]]
שרשרת עסקות בה הפלט של עסקה אחת הנו הקלט של העסקה הבאה.
image::images/mbc2_0204.png["Transaction chain"]

==== טיפול בעודף

((("change, making")))((("change addresses")))((("addresses", "change addresses")))עסקות ביטקוין רבות כוללות פלט לכתובת הבעלים החדש וכתובת הבעלים הנוכחי, הנקראת כתובת העודף _change_ address. זאת מכיון שעסקות שקלטי עסקות, כמו שטרי חוב, אינם יכולים להתחלק. אם רחשת ב 5 דולר ושילמת ב 20 דולר, את/ה מצפה לקבל עודף 15 דולר. אותו העקרון מיושפ בעסקות ביטקוין. אם רכשת משהו ב 5 ביטקוין ושילמת מפלט של 20 דולר, תשלח/י פלט אחד של 5 ביטקוינים לבעל החנות ופלט שני של 15 ביטקוים חזקה לעצמך כעודף  (פחות עמלת עסקה מבוקשת). חשוב לציין שכתובת עסקת העודף אינה צריכה להיות אותה הכתובת ממנה שולם, ומשיקולי פרטין בדרך כלל זו תהיה כתובת אחרת.מארנק הבעלים 

ארנקים שונים משתמשים באיסטרטגיות שונות כאשר מסכמים קלטים עבור ביצוע תשלום שהמשתמש ביקש. הם יכולים לרכז קלטים רבים בערכים קטנים או להשתמש בלקט אחד הגדול או שווה לגובה התשלום המבוקש. אלא אם הארנק מסוגל לאתר קלטים כך שהסכום בדיוק שווה לדרישה בתוספת העמלה, הארנק יצרך לייצר עודף. הדבר דומה לאופן בו אנשים מנהלים כסף מזומן. אם תמיד תבחר/י את השטר הגדול ביותר, תמיד יווצר מצב של כסף קטן רב בכיסך. אם רק תשתמש/י בכסף קטן, תמיד תוותר/י עם שטרות גדולים בלבד. אנשים מוצאים באופן תת מודע את האיזון בין שתי האפשרויות הקיצוניות האלה, ומתכנתי ארנקים שואפים לתכנת איזון זה.

((("transactions", "defined")))((("outputs and inputs", "defined")))((("inputs", see="outputs and inputs"))) לסיכום, עסקות, _transactions_ מעבירות ערך מ _transaction inputs_ אל _transaction outputs_. קלט הנו הפניה לפלט של עסקה קודמת, להראות מהיכן נלקח הערך, ופלט העסקה מפנה ערך ספציפי לכתובת של הבעלים החדש של הביטקוינים ויעול לכלול פלט עודף להחזיר לבעלים של הקלט. פלטים של העסקה יכולים לשמש כקלטים בעסקה חדשה, וכך ליצור שרשרת בעלויות בעקבות התנועה של הערך מבעלים אחד למשנהו..  (ראה<<blockchain-mnemonic>>).

==== צורות של עסקות שכיחות

האופן השכיח ביותר של עסקה הנו תשלום פשוט מכתובת אצת לאחרת, אשר בדרך כלל כוללת עודף שחוזר לבעלים המקורי. זהו סוג עסקה עם קלט אחד ושני פלטים כפי שמוצג ב  <<transaction-common>>.

[[transaction-common]]
העסקה השכיחה ביותר
image::images/mbc2_0205.png["Common Transaction"]

צורה שכיחה אחרת של עסקה היא כזו שמאחדת קלטים רבים לפלט אחד  (ראה <<transaction-aggregating>>). הדבר מייצג הקבלה לעולם הפיזי בו מחליפים אוסף מטבעות ושטרות בתמורה לשטר אחד גדול יותר. עסקות שכאלה מתבצעות ע"י אפליקציות ארנקים כדי לנקות סכומים רבים אשר התקבלו כעודף מתשלומים.

[[transaction-aggregating]]
עסקה מאחדת כספים
image::images/mbc2_0206.png["Aggregating Transaction"]

ולבסוף, צורת עסקה אחרת אשר נראית לעתים קרובות בספר הנה"ח של ביטקוין אשר מפצלת קלט אחד לפלטים רבים המייצגים מקבלים רבים  (ראה <<transaction-distributing>>). סוג זה של עסקה משומש לעתים אצל גופים מסחריים כדי לבזר כספים, בעת שמעבדים משכורות לעובדים רבים.  ((("", startref="Tover02")))

[[transaction-distributing]]
עסקה המבזרת כספים
image::images/mbc2_0207.png["Distributing Transaction"]

=== בניית עסקה

((("transactions", "constructing", id="Tconstruct02")))((("wallets", "constructing transactions"))) אפלקצית הארנק של אליס כוללת את כל הכללים לבחירת הקלטים והפלטים המתאימים לבניית עסקה על פי התנאים של אליס.   אליס רק צריכה לציין יעד וסכום, וכל השאר קורה באפליקצית הארנק ללא שתצטרך לראות את הפרטים. חשוב לציין שאפליקצית ארנק יכולה ליצור עסקות גם אפילו כשהיא מנותקת מהרשת והאינטרנט. כפי שכותבים צ'ק בבית ואחר כך שולחים אותו לבנק במעטפה, העסקה אינה צריכה להיות מוכנה וחתומה כאשר מחוברים לרשת ביטקוין.

==== קבלת הקלטים הנכונים

((("outputs and inputs", "locating and tracking inputs"))) אפליקצית הארנק של אליס תצטרך קודם כל לאתר את הקלטים שיכולים לשלם את הסכום שהיא רוצה לשלוח לבוב. מרבית הארנקים שומרים מידע על הפלטים הזמינים השייכים לכתובות הארנק. לכן ארנקה של אליס יכלול עותק של עסקות הפלט עם ג'ו בעת שנוצרו בתמורה למזומן  (ראה <<getting_first_bitcoin>>). אפליקצית ארנק ביטקוין שמריצה צומת שלמה כוללת בפועל העתק של כל עסקה בבלוקצ'יין שהפלט שלה טרם נוצל. הדבר מאפשר לארנק לבנות את הקלטים של העסקה ולוודא בזריזות שעסקות שנכנסות הנן בעלות הקלטים הנכונים. . אבל כיון שצמתות שלמות תופסות נפח דיסק גדול, מרבית ארנקי המשתמש מריצים תוכנות קלות משקל אשר עוקבת רק אחר פלטי העסקות של המשתמש שטרם נוצלו, 

אם אפליקצית ארנק אינה מתחזקת עותק של פלטי עסקה שטרם שומשו, היא יכולה לבקש את המידע הזה מרשת ביטקוין תוך שימוש של מגוון   APIs ששואלות על מידע מצמתות מלאות בקריאה דרך ממשק תוכנה    (API).  <<example_2-2>> מראה בקשת  API , הבנויה כפקודת  HTTP GET לכתובת URL (דף אינטרנט) ספציפית.. כתובת URL זו תביא את כל פלטי העסקה שטרם שומשו, כשהיא מספקת לכל אפליקציה שהיא את המידע הנחוץ לבניית קלטי עסקה לצורך הוצאה.   אנו משתמשים בפקודת  HTTP פשוטה _cURL_ כדי לקבל את התגובה.

[[example_2-2]]
נתבוננות בכל הפלטים של אליס שטרם נוצלו בכתובות ביטקוין שלה.
====
[source,bash]
----
$ curl https://blockchain.info/unspent?active=1Cdid9KFAaatwczBwBttQcwXYCpvK8h7FK
----
====

[source,json]
----
{

	"unspent_outputs":[

		{
			"tx_hash":"186f9f998a5...2836dd734d2804fe65fa35779",
			"tx_index":104810202,
			"tx_output_n": 0,
			"script":"76a9147f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a888ac",
			"value": 10000000,
			"value_hex": "00989680",
			"confirmations":0
		}

	]
}
----


התגובה ב <<example_2-2>> מראה פלט אחד שטרם נוצל  (אחד שטרם שומש) בבעלות כתובת של אליס  +1Cdid9KFAaatwczBwBttQcwXYCpvK8h7FK+. התגובה כוללת את ההפניה לעסקה בה הפלט שטרם נוצל נמצא  (התשלום מג'ו) וערך של 10 מיליון סאטושים המקביל ל 0.10 ביטקוין. עם מידע זה אפליקצית הארנק של אליס יכולה להרכיב עסקה להעברת ערך לכתובת הבעלים החדש. 

[TIP]
====
צפיה ב https://www.blockchain.com/btc/tx/7957a35fe64f80d234d76d83a2a8f1a0d8149a41d81de548f0a65a8a999f6f18[transaction from Joe to Alice].
====

כפי שניתן לראות, ארנקה של אליס כולל מספיק ביטקוינים בפלט אחד שטרם שומש, כדי לשלם עבור ספל הקפה. אם זה לא היה המקרה, אפליקצית ארנקה של אליס היתה צריכה לחטט דרך ערימת פלטים קטנים יותר שטרם שומשו, כגון בחירת מטבעות מהקופה עד אשר תמצא מספיק כדי לשלם עבור הקפה. בשני המקרים, יתכן שיהיה צורך לקבל חזרה עודף, אשר נראה זאת בחלק הבא, בעת שאפליקצית הארנק תיצור את פלטי העסקה (תשלומים).


==== בניית הפלטים

((("outputs and inputs", "creating outputs")))A transaction output is created in the form of a script that creates an encumbrance on the value and can only be redeemed by the introduction of a solution to the script. In simpler terms, Alice's transaction output will contain a script that says something like, "This output is payable to whoever can present a signature from the key corresponding to Bob's address." Because only Bob has the wallet with the keys corresponding to that address, only Bob's wallet can present such a signature to redeem this output. Alice will therefore "encumber" the output value with a demand for a signature from Bob.

העסקה תכלול גם פלט שני, כיון שהכסף של אליס הנו בצורה של פלט 0.10 BTC שזה יותר מדי עבור 0.015 BTC שעולה ספל הקפה. אליס תצטרך פלט של 0.085 TC כעודף. תשלום העודף של אליס נוצר ע"י ארנקה כפלט באותה עסקה בה התשלום לבוב. בעיקרו, ארנקה של אליס מפרק את הערך לשני תשלומים: האחד לבוב והאחר חזרה לעצמה. אליס יכולה אז להשתמש (להוציא) את פלט העודף בעסקות עוקבות.

לבסוף, כדי שעסקה תעובד ע"י הרשת בזמן מתקבל על הדעת, אפליקצית הארנק של אליס תוסיף עמלה קטנה. ,  אין הדבר בא לידי ביטוי באופן מפורש בעסקה אלא בהפרש בין סך הקלטים לסך הפלטים. אם במקום לקחת 0.085 כעודף, אליס תיצור רק 0.0845 בעסקה השניה, יווצר  0.0005 BTC (מחצית מיליביטקוין) שיוותר. הקלט של 0.10 BTC לא שומש במלואו ע"י שתי העסקות, כיון שסכומן קטן מ 0.10. ההפרש שנוצר הנו העודף _transaction fee_ אשר הכורה מלקט עבור אישור העסקה והכללתה בבלוק שירשם בשרשרת הבלוקים.

העסקה שנוצרה יכולה להראות ע"י אפליקצית ווב של דפדפן בלוקצ'יין המוצגת כאן <<transaction-alice>>.

[[transaction-alice]]
[role="smallerseventyfive"]
העסקה של אליס לקפה של בוב
image::images/mbc2_0208.png["Alice Coffee Transaction"]

[[transaction-alice-url]]
[TIP]
====
צפיה ב  https://www.blockchain.com/btc/tx/0627052b6f28912f2703066a912ea577f2ce4da4caa5a5fbd8a57286c345c2f2[transaction from Alice to Bob's Cafe].
====

==== הכללת העסקה בספר הנה"ח

העסקה שיצרה אפליקצית הארנק של אליס אורכה 258 בתים וכוללת את כל הנחוץ לאשר בעלות על הכסף ולהקצות בעלים חדשים. כעת, העסקה צריכה לעבור לרשת ביטקוין שם היא תהפוך לחלק מהבלוקצ'יין. בחלק הבא נראה כיצד עסקה כהופכת חלק מבלוק חדש וכיצד בלוק זה "נכרה". ולבסוף, נראה כיצד הבלוק החדש, כאשר מתווסף לשרשרת הבלוקים, הופך לאמין יותר ברשת ככל שיותר בלוקים מתווספים.

===== שידור העסקה

((("propagation", "process of"))) כיון שעסקה כוללת את כל המידע הנחוץ לעיבוד, אין זה משנה כיצד או לאן היא משודרת ברשת ביטקוין. רשת ביטקוין הנה רשת ישירה (עמית לעמית) כאשר כל תחנת (לקוח) ביטקוין משתתפת ע"י התחברות למספר תחנות ביטקוין אחרות. , המטרה של רשת ביטקוין הנה להפיץ עסקות ובלוקים לכל המשתתפים.

===== כיצד מתבצעת ההפצה

((("bitcoin nodes", "defined")))((("nodes", see="bitcoin nodes"))) כל מערכת, כגון שרת, אפליקצית מחשב שולחני, או ארנק אשר משתתפים ברשת ביטקוין ע"י "דיבור" בשפת הפרוטוקול, נקראות צמתות ביטקוין   _bitcoin node_. אפליקצית הארנק של אליס יכולה לשלוח עסקה חדשה לכל צומת ביטקוין אליה היא מחוברת בכל סוג תקשורת שהוא: קוי, וייפאי, נייד וכדומה. ארנק ביטקוין שלה אינו חייב להיות מקושר ישירות לארנק של בוב והיא לא חייבת להשתמש ברשת התקשורת המוצעת בקפה בוב, למרות ששתי אפשרויות אלה ואלידיות גם כן. . ((("propagation", "flooding technique")))((("flooding technique"))) כל צומת שתקבל עסקה ואלידית שטרם ראתה קודם לכן תשדר אותה מיידית לכל הצמתות אליהן קשורה, טכניקת הפצה הידועה בשם הצפה  _flooding_. כך העסקה תופץ במהירות ברחבי רשת העמית לעמית , תוך הגעה לשיעור גבוה של הצמתות בתוך שניות ספורות.

===== נקודת מבטו של בוב

אם אפליקצית הארנק של בוב מקושרת ישירות לזו של אליס, יתכן שבוב יהיה הצומת הראשונה שמקבלת את העסקה. אבל אפילו אם העסקה נשלחת דרך צמתות אחרות, היא תגיע לארנקו של בוב בתוך שניות ספורות. ארנקו של בוב יזהה מיד את עסקת אליס כתשלום נכנס כיון שהיא כוללת פלטים הניתנים לפדיון ע"י המפתחות של בוב. אפליקצית הארנק של בוב יכולה גם לאמת באופן עצמאי שהעסקה מוגדרת כהלכה, משתמשת בפלט שטרם נוצל, וכוללת מספיק עמלה שתכלול אותה בבלוק הבא. בנקודה זו בוב יכול להניח, בסיכן נמוך, שהעסקה תשולב בקרוב בבלוק ותאושר. 

[TIP]
====
((("confirmations", "of small-value transactions", secondary-sortas="small-value transactions"))) יש אי הבנה שגורה לגבי עסקות ביטקוין שהן צריכות להיות מאושרת בהמתנה של 10 דקות לבלוק חדש, עד ל 60 דקות ל 6 אישורים מלאים. אמנם אישורים מבטיחים שהעסקה נתקבלה ע"י כלל הרשת, עיכוב שכזה אינו הכרחי לפריטים זולים כגון ספל קפה. סוחר יכול לקבל עסקות קטנות ערך ללא אישורים, ללא סיכון גדול מאשר תשלום בכרטיס אשראי שהתבצע ללא מזהה או חתימה, שסוחרים מקבלים כיום. .((("", startref="Tconstruct02")))
====

=== כריית ביטקוין

((("mining and consensus", "overview of", id="MACover02")))((("blockchain (the)", "overview of mining", id="BToverview02"))) העסקה של אליס מופצת כעת ברשת ביטקוין. היא אינה הופכת לחלק משרשרת הבלוקים  _blockchain_ עד אשר היא מאומתת ונכללת בבלוק בתהליך שנקרא כרייה  _mining_. ראה <<mining>> להסבר מפורט.

מערכת האמון של ביטקוין מבוססת על חישובים. עסקות מחוברות ל _blocks_, אשר דורש  כמות עצמוה של חישובים, אך רק כמות דלה של חישוב כדי לאמת אותו כמוכח. תהליך הכרייה משרת בביטקוין שתי מטרות:

* ((("mining and consensus", "consensus rules", "security provided by")))((("consensus", see="mining and consensus"))) צמתות כרייה מאמתות אל כל העסקות בהפניה ל _consensus rules_. של ביטקוין. לכן, כרייה מספקת בטחון לעסקות ביטקוין באמצעות דחיה של עסקות שגויות או שנבנו באופן לא תקין.
* כרייה יוצר ביטקוין חדש בכל בלוק, כמעט כמו הדפסה של בנק מרכזי של כסף חדש. הכמות של ביטקוין שנוצרת בכל בלוק מוגבלת ויורדת ככל שהזמן חולף, במועדים קבועים מראש.


כרייה משיגה את האיזון בין עלות לתמורה. כרייה משתמשת בחשמל לפתור בעיה מתמטית. הכורה הזוכה יאסוף פרס   _reward_ i בצורה של ביטקוין ועמלות עסקה. אבל הפרס ינתן רק אם הכורה אימת נכונה את כל העסקות, לשבעות הרצון של  , _consensus_.  איזון עדין זה מספק אבטחה לביטקוין ללא צורך ברשות מרכזית.

דרך טובה לתאר כרייה הנה לדמות משחק תחרותי ענק של סודוקו שמתחיל מחדש כל פעם שמישהו מוצא פתרון, ואשר דרגת הקושי שלו מתעדכנת אוטומטית כדי לגרום לכך שפתרון ימצא כל 10 דקות. דמיין/י פאזל סדוקו ענק בגודל של  כמה אלפי שורות ועמודות. אם אראה לך פזל פתור, ניתן יהיה בקלות לודא נכונותו. אבל אם ישנן מספר ריבועים עם ערך והשאר ריקים, יקח זמן רב של עבודה לפתור. הקושי של הפאזל יכול לעבור התאמה בעזרת שינוי הגודל (יותר או פחות שורות ועמודות) אבל עדיין אפשר לאמתו בקלות גם עם מספר שורות ועמודות מאד גדול. הפאזל שבשימוש ביטקוין מבוסס על האש קריפטוגרפי וממפגין תכונות דומות. הוא אסימטרי, קשה מאד לפתרון אבל קל לאימות, ודרגת הקושי ניתנת לכיוונון.  

((("mining and consensus", "mining farms and pools"))) ב <<user-stories>>, הצגנו את ((("use cases", "mining for bitcoin"))) ג'ינג, יזם בשנחאי. ג'ינג מריץ חוות כרייה.  _mining farm_, אשר הנה  עסק המריץ אלפי שרתי כרייה יעודיים המתחרים על הפרס כל 10 דקות לערך.  מחשבי הכרייה של ג'ינג מתחרים עם אלפי מערכות דומות במירוץ גלובלי למצוא פתרון לעסקות בלוק. ((("Proof-of-Work algorithm")))((("mining and consensus", "Proof-of-Work algorithm")) מציאת פתרון, מה שנקרא הוכחת עבודה- _Proof-of-Work_ (PoW), דורשת קוואדריליון חישובי האש לשניה בכל רחבי רשת ביטקוין. האלגוריתם של הוכחת העבודה כרוך בהאשינג חוזר ונשנה של כותרת הבלוק ומספר אקראי עם אלגוריתם קריפטוגרפי  SHA256 עד אשר פתרון  התואם את המבנה המוגדר מראש מתקבל. . הכורה הראשון אשר מוצר פתרון שכזה זוכה בסיבוב זה של התחרות ומפרסם את הבלוק הזה בשרשרת הבלוקים. 

Jing started mining in 2010 using a very fast desktop computer to find a suitable Proof-of-Work for new blocks. As more miners started joining the bitcoin network, the difficulty of the problem increased rapidly. Soon, Jing and other miners upgraded to more specialized hardware, with high-end dedicated graphical processing units (GPUs), often used in gaming desktops or consoles. At the time of this writing, the difficulty is so high that it is profitable only to mine with ((("application-specific integrated circuits (ASIC)")))application-specific integrated circuits (ASIC), essentially hundreds of mining algorithms printed in hardware, running in parallel on a single silicon chip. ((("mining pools", "defined")))Jing's company also participates in a _mining pool_, which much like a lottery pool allows several participants to share their efforts and rewards. Jing's company now runs a warehouse containing thousands of  ASIC miners to mine for bitcoin 24 hours a day. The company pays its electricity costs by selling the bitcoin it is able to generate from mining, creating some income from the profits.

=== כריית עסקות בבלוקים

((("blocks", "mining transactions in"))) עסקות חדשות זורמות לרשת ביטקוין באופן שוטף מארנקי משתמשים ואפליקציות אחרות. כשאלה נצפים ע"י צמתות הרשת, הם מוכנסים למעגר זמנני של עסקות לא מאומתות, שמטופלות ע"י כל צומת. כאשר כורים מקימים בלוק חדש, הם מוסיפים עסקות לא מאומתות מהמאגר הזה, לבלוק החדשואז מנסים להוכיח את תקפותו של הלוק החדש בעזרת אלגוריתם הכרייה (הוכחת עבודה). תהליך הכריה מוסבר בפירוט ב  <<mining>>.

Transactions are added to the new block, prioritized by the highest-fee transactions first and a few other criteria. Each miner starts the process of mining a new block of transactions as soon as he receives the previous block from the network, knowing he has lost that previous round of competition. He immediately creates a new block, fills it with transactions and the fingerprint of the previous block, and starts calculating the Proof-of-Work for the new block. Each miner includes a special transaction in his block, one that pays his own bitcoin address the block reward (currently 6.25 newly created bitcoin) plus the sum of transaction fees from all the transactions included in the block. If he finds a solution that makes that block valid, he "wins" this reward because his successful block is added to the global blockchain and the reward transaction he included becomes spendable. ((("mining pools", "operation of")))Jing, who participates in a mining pool, has set up his software to create new blocks that assign the reward to a pool address. From there, a share of the reward is distributed to Jing and other miners in proportion to the amount of work they contributed in the last round.

((("candidate blocks")))((("blocks", "candidate blocks"))) העסקה של אליס נלקחה ע"י הרשת ונכנסה למאגר הזמני. לאחר שאומתה ע"י תוכנת הכרייה הוא הוכנסה לבלוק חדש, שנקרא מועמד _candidate block_, שיוצר ע"י המאג של ג'נג. כל הכורים המשתתפים במאגר הזה מיד החלו לחשב את הוכחת העבודה של הבלוק המועמד בערך לאחר חמש דקות מאז שהעסקה שוגרה מארנקה של אליס, אחד מכורי ה ASIC של ג'ינג מצא פתרון לבלוק המועמד והכריז על כך ברשת. לאחר שהכורים האחרים אישרו את הבלוק הזוכה הם החלו את המירוץ ליצירת הבלוק הבא. 

הבלוק הזוכה של ג'ינג הפך להיות חלק מהבלוקצ'יין כבלוק #277316, וכלל 419 עסקות, כולל זו של אליס.. הבלוק הכולל את העסקה של אלים נספר כ"אישור" אחד  של העסקה ההיא.

[TIP]
====
You can see the block that includes https://blockchain.info/btc/block/277316[Alice's transaction].
====

((("confirmations", "role in transactions")))אחרי בערך 19 דקות בלוק חדש, #277317, נכרה ע"י כורה אחר. . כיון שהבלוק החדש נבנה מעל בלוק #277316 שבה כלולה עסקת אליס, היא הוסיפה עוד תחשיביות לבלוקצ'יין מה שחיזק את האמון בעסקות אלה.  כל בלוק שנכרה מעל לבלוק שכולל את העסקה נספר כאישור נוסף של עסקת אליס. ככל שהבלוקים נערמים האחד מעל השני, הם גורמים ליותר ויותר אמון ע"י הרשת.  

((("genesis block")))((("blocks", "genesis block")))((("blockchain (the)", "genesis block"))) בתרשים ב <<block-alice1>>,  אנו יכולים לראות את בלוק #277316, שכולל את עסקת אליס. מתחתיו יש 277,316 בלוקים (כולל בלוק #0), מקושרים ביניהם בשרשרת בלוקים (בלוקצ'יין) כל הדרך עד בלוק #0, הידוע כבלוק בראשית  _genesis block_. משך הזמן, ככל שהגובה בבלוקים עולה כך גם קושי החישוב לכל בלוק והשרשרת כמכלול, הבלוקים שנכרו לאחר הבלוק של עסקת אליס משמשים כאישורים נוספים כיון עורמים חישובים נוספים  בשרשרת שגדלה וגדלה. ככלל אצבע, כל בלוק עם 6 אישורים מעליו נחשב כאחד שלא ניתן לשינוי.  כיון שתדרש כמות עצומה של חישובים לבטל ששה בלוקים ולחשב מחדש. אנו נבחן את תהליך הכריה והאופן בו יוצרת אמון ביתר פירוט ב  <<mining>>.((("", startref="BToverview02")))((("", startref="MACover02")))

[[block-alice1]]
. עסקת אליס הכלילה בבלוק #277316
image::images/mbc2_0209.png["Alice's transaction included in a block"]

=== שמוש של העסקה

((("spending bitcoin", "simple-payment-verification (SPV)")))((("simple-payment-verification (SPV)")))כעת אחר שהעסקה של אליס נכללה בשרשרת הבלוקים כחתק מבלוק,  היא חלק מספר הנה"ח המבוזר של ביטקוין וגלויה לכל אפליקצית בלוקצ'יין. כל תחנת ביטקוין יכולה עצמאית לודא את נכונות העסקה והאפשרות להוציא אותה. תחנות צומת שלמה יכולות לאתר את מקור הכסף מהרגע בו הביטקוין נוצר בבלוק, והתקדמות מדורגת מעסקה לעסקה אד אשר מגיעים לכתובת של בוב.  ארנקים קליםיכולים לבצע את מה שמכונה אימות תשלומים מפושט (ראה <<spv_nodes>>) באמצעות אישור שהעסקה נכללת בבלוקצ'יין ויש מספר בלוקים מעל הבלוק שלה. בכך מסופק הבטחון שהכורים קיבלו אותה כואלידית 

בוב יכול כעת להוציא עסקה זו ואחרות.. למשל בוב יכול לשלם כעת לקבלן או ספק מהעסקה של ספל הקפה של אליס לבעלים החדשים האלה.  סביר להניח שתוכנת ביטקוין של בוב תרכז תשלומים קטנים רבים לתשלום אחד גדול יותר, אולי לרכז את כל רווחי ביטקוין מהיום לעסקה אחת.   הדבר יאחד את התשלומים לפלט יחיד (וכתובת אחת). לתרשים של איחוד עיסקות ראה  <<transaction-aggregating>>.

As Bob spends the payments received from Alice and other customers, he extends the chain of transactions. Let's assume that Bob pays his web designer Gopesh((("use cases", "offshore contract services"))) in Bangalore for a new web page. Now the chain of transactions will look like <<block-alice2>>.

[[block-alice2]]
עסקת אליס כחלק משרשרת עסקות מג'ו עד גופש.
image::images/mbc2_0210.png["Alice's transaction as part of a transaction chain"]

בפרק זה ראינו כיצד עסקות בונות שרשרת אשר מעבירה ערך מבעלים אחד לאחר. עקבנו גם אחר העסקה של אליס, מרגע הווצרה בארנקה דרך רשת ביטקוין לכורים אשר תעדו אותה בבלוקצ'יין. בשאר הספר נבחן את הטכנולוגיות אשר נמצאות מאחורי ארנקים, כתובות, חתימות, עסקות, הרשת, ולבסוף כרייה. .((("", startref="BCover02")))((("", startref="DCSover02"))) ((("", startref="UCcoffee02")))